<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SNA Invoicing</title>
    <style>
        :root {
            /* Apple-ish neutrals & rhythm */
            --ink: #111;
            --muted: #6a6a6a;
            --line: #e8e8e8;
            --bg: #fbfbfc;
            --card: #fff;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0, 0, 0, .06);
            --pad: 12px;
            --ring: 0 0 0 4px rgba(0, 0, 0, .06);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Arial;
            margin: 0 auto;
            padding: 16px;
            color: var(--ink);
            background: var(--bg);
            max-width: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app {
            width: 96%;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header */
        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 4px 0 2px;
        }

        .brand .logo {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: linear-gradient(#fff, #f7f7f7);
            box-shadow: var(--shadow);
            display: grid;
            place-items: center;
            font-weight: 800;
            letter-spacing: .3px;
        }

        h1.heading {
            margin: 0;
            font-size: 26px;
            letter-spacing: .2px;
            font-weight: 800;
        }

        .subhead {
            margin: 4px 0 14px;
            text-align: center;
            color: var(--muted);
            font-size: 14px;
        }

        .divider {
            height: 1px;
            border: 0;
            background: linear-gradient(90deg, transparent, #00000022, transparent);
            margin: 10px 0 14px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px auto 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--card);
            color: var(--ink);
            font-weight: 700;
            font-size: 14px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
        }

        .btn:hover {
            transform: translateY(-1px)
        }

        .btn:active {
            transform: translateY(0)
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        /* Container */
        #invoice-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 0 auto 10px;
            width: 100%;
            overflow: visible;
            /* ensure popovers not clipped */
        }

        /* Row Card: 12-col grid for super alignment */
        .invoice-row {
            position: relative;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 14px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 10px 12px;
            align-items: end;
            width: 100%;
            overflow: visible;
            /* important for dropdown */
        }

        /* Fields */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field label {
            font-size: 11.5px;
            font-weight: 800;
            color: #3f3f3f;
            letter-spacing: .3px;
            text-transform: uppercase;
        }

        input {
            padding: 11px 12px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
            color: var(--ink);
            font-size: 15px;
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        input:focus {
            border-color: #d0d0d0;
            box-shadow: var(--ring);
        }

        /* Custom Select (Driver) to avoid clipping */
        .select {
            position: relative;
            user-select: none;
        }

        .select-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 12px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
            font-size: 15px;
            cursor: pointer;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        .select-trigger:focus {
            outline: none;
            border-color: #d0d0d0;
            box-shadow: var(--ring);
        }

        .select-caret {
            width: 16px;
            height: 16px;
        }

        .select-list {
            position: absolute;
            left: 0;
            right: auto;
            top: calc(100% + 6px);
            min-width: 220px;
            max-width: 280px;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, .12);
            padding: 6px;
            z-index: 9999;
            display: none;
        }

        .select.open .select-list {
            display: block;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
        }

        .option:hover {
            background: #f6f6f6;
        }

        .opt-icon {
            width: 18px;
            height: 18px;
            border: 1px solid var(--line);
            border-radius: 5px;
            display: grid;
            place-items: center;
            font-size: 11px;
        }

        /* Grid Spans */
        .col-2 {
            grid-column: span 2
        }

        .col-3 {
            grid-column: span 3
        }

        .col-4 {
            grid-column: span 4
        }

        .col-6 {
            grid-column: span 6
        }

        .col-12 {
            grid-column: span 12
        }

        /* Row actions (icon-only) */
        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            grid-column: span 12;
            margin-top: 2px;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            transition: transform .05s ease, background .15s ease;
            box-shadow: none;
        }

        .icon-btn:hover {
            background: #f6f6f6;
            transform: translateY(-1px);
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
            stroke: #333;
        }

        .hint {
            text-align: center;
            color: var(--muted);
            font-size: 13px;
            margin-top: 6px;
        }

        /* Broker combo: input + caret, same look as driver */
        .select.combo {
            position: relative;
        }

        .select.combo .select-input {
            width: 100%;
            padding: 11px 36px 11px 12px;
            /* room for caret */
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
            font-size: 15px;
            color: var(--ink);
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        .select.combo .select-input:focus {
            outline: none;
            border-color: #d0d0d0;
            box-shadow: var(--ring);
        }

        .select.combo .select-caret-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border: 0;
            background: transparent;
            cursor: pointer;
            display: grid;
            place-items: center;
        }

        .select.combo .select-caret-btn svg {
            width: 18px;
            height: 18px;
        }

        .select.combo .select-list {
            min-width: 100%;
        }

        /* match input width */


        /* ===== Dark Theme â€” Midnight Bluish ===== */
        body.dark {
            /* Palette */
            --bg: #0b1220;
            /* page background (midnight navy) */
            --card: #0f1b31;
            /* elevated surfaces/cards */
            --bg-alt: #0c172c;
            /* subtle contrast background */
            --ink: #e6edf6;
            /* primary text */
            --muted: #9fb0cc;
            /* secondary text */
            --line: #223456;
            /* borders/dividers */
            --accent: #4f8cff;
            /* focus/interactive accent */
            --radius: 16px;
            --shadow: 0 12px 28px rgba(2, 16, 40, .55);
            --ring: 0 0 0 4px rgba(79, 140, 255, .18);

            background: radial-gradient(1200px 800px at 20% -10%, #0e1a33 0%, #0b1220 55%) fixed, var(--bg);
            color: var(--ink);
        }

        /* Header/brand */
        body.dark .brand .logo {
            border-color: var(--line);
            background: linear-gradient(180deg, #10213d, #0f1b31);
            box-shadow: var(--shadow);
            color: var(--ink);
        }

        body.dark h1.heading {
            color: var(--ink);
        }

        body.dark .subhead {
            color: var(--muted);
        }

        /* Divider */
        body.dark .divider {
            background: linear-gradient(90deg, transparent, rgba(159, 176, 204, .35), transparent);
        }

        /* Cards / rows */
        body.dark .invoice-row {
            background: var(--card);
            border-color: var(--line);
            box-shadow: var(--shadow);
        }

        /* Fields + placeholders */
        body.dark .field label {
            color: #c7d4ea;
        }

        body.dark input,
        body.dark select,
        body.dark textarea {
            background: #122441;
            color: var(--ink);
            border: 1px solid var(--line);
        }

        body.dark input::placeholder,
        body.dark textarea::placeholder {
            color: rgba(159, 176, 204, .75);
        }

        body.dark input:focus,
        body.dark select:focus,
        body.dark textarea:focus {
            border-color: #335b97;
            box-shadow: var(--ring);
        }

        /* Buttons */
        body.dark .btn {
            background: #10233f;
            color: var(--ink);
            border-color: var(--line);
            box-shadow: var(--shadow);
        }

        body.dark .btn:hover {
            background: #132a4c;
        }

        body.dark .btn:active {
            background: #0e1f38;
        }

        body.dark .btn svg {
            stroke: var(--ink);
        }

        /* Icon-only buttons */
        body.dark .icon-btn {
            background: #10233f;
            border-color: var(--line);
        }

        body.dark .icon-btn:hover {
            background: #132a4c;
        }

        body.dark .icon-btn svg {
            stroke: var(--ink);
        }

        /* Custom select (driver) */
        body.dark .select-trigger {
            background: #122441;
            border-color: var(--line);
            color: var(--ink);
        }

        body.dark .select-trigger:focus {
            border-color: #335b97;
            box-shadow: var(--ring);
        }

        body.dark .select-list {
            background: #0f1b31;
            border-color: var(--line);
            box-shadow: 0 16px 40px rgba(2, 16, 40, .65);
        }

        body.dark .option {
            color: var(--ink);
        }

        body.dark .option:hover {
            background: rgba(79, 140, 255, .12);
        }

        body.dark .opt-icon {
            border-color: var(--line);
            background: #122441;
            color: #c7d4ea;
        }

        /* Broker combo (input-first) */
        body.dark .select.combo .select-input {
            background: #122441;
            border-color: var(--line);
            color: var(--ink);
        }

        body.dark .select.combo .select-input:focus {
            border-color: #335b97;
            box-shadow: var(--ring);
        }

        body.dark .select.combo .select-caret-btn svg {
            stroke: var(--ink);
        }

        body.dark .select.combo .select-list {
            min-width: 100%;
            background: #0f1b31;
            border-color: var(--line);
        }

        /* Toolbar container and app shell */
        body.dark .app {
            color: var(--ink);
        }

        body.dark #invoice-container {
            /* grid holder */
        }

        /* Hints / minor text */
        body.dark .hint {
            color: var(--muted);
        }

        /* Generic tables (if any in UI) */
        body.dark table {
            color: var(--ink);
        }

        body.dark th,
        body.dark td {
            border-color: var(--line);
        }

        /* Scrollbars (WebKit) â€” optional polish */
        body.dark *::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        body.dark *::-webkit-scrollbar-thumb {
            background: #223456;
            border-radius: 8px;
        }

        body.dark *::-webkit-scrollbar-thumb:hover {
            background: #2a3e68;
        }

        .dark-toggle-fixed {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 9999;
            box-shadow: var(--shadow);
        }

        body.dark .dark-toggle-fixed {
            background: var(--card);
        }




        @media (max-width: 900px) {
            .col-6 {
                grid-column: span 12
            }

            .col-4 {
                grid-column: span 6
            }

            .col-3 {
                grid-column: span 6
            }

            .col-2 {
                grid-column: span 6
            }
        }

        @media (max-width: 600px) {
            h1.heading {
                font-size: 22px
            }

            .subhead {
                font-size: 13px
            }

            .btn {
                font-size: 13px;
                padding: 10px 14px
            }

            input {
                font-size: 14px;
                padding: 10px
            }

            .invoice-row {
                gap: 8px 10px
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="brand">
            <h1 class="heading">SNA TRANSPORT INC.</h1>
            <button class="icon-btn dark-toggle-fixed" id="darkModeToggle" aria-label="Toggle dark mode"
                title="Toggle dark mode">
                <!-- Moon (default icon) -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
                    stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z" />
                </svg>
            </button>

        </div>
        <p class="subhead">Invoicing</p>
        <hr class="divider" />

        <div id="invoice-container"></div>

        <div class="toolbar" role="toolbar" aria-label="invoice actions">
            <button class="btn add-row" aria-label="Add invoice">
                <!-- Plus icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
                    stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                Add Invoice
            </button>
            <button class="btn clear-all" aria-label="Clear all invoices">
                <!-- Eraser icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
                    stroke-linejoin="round" aria-hidden="true">
                    <path d="M3 17l7-7 11 11H7z" />
                    <path d="M14 3l7 7" />
                </svg>
                Clear All
            </button>
            <button class="btn generate" id="generate-invoices" aria-label="Generate invoices">
                <!-- Paper icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
                    stroke-linejoin="round" aria-hidden="true">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <path d="M14 2v6h6" />
                </svg>
                Generate Invoice
            </button>
        </div>

        <p class="hint">SNA TRANSPORT INC. â€¢ MC 873145 â€¢ DOT 2516418</p>
    </div>

    <!-- jsPDF + AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"
        integrity="sha256-vIL0pZJsOKSz76KKVCyLxzkOT00vXs+Qz4fYRVMoDhw=" crossorigin="anonymous">
        </script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.22/dist/jspdf.plugin.autotable.js"></script>

    <script>
        const invoiceContainer = document.getElementById('invoice-container');
        const addRowButton = document.querySelector('.add-row');
        const clearAllButton = document.querySelector('.clear-all');
        const generateInvoicesButton = document.getElementById('generate-invoices');

        function formatCurrency(val) {
            const num = Number(val || 0);
            return isFinite(num) ? `$${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '$0.00';
        }

        /* ---------- Custom Select (Driver) ---------- */
        function createDriverSelect() {
            const wrap = document.createElement('div');
            wrap.className = 'field col-3';
            wrap.innerHTML = `
    <label>Driver</label>
    <div class="select driver-select" data-value="">  <!-- ðŸ‘ˆ add driver-select -->
      <button type="button" class="select-trigger" aria-haspopup="listbox" aria-expanded="false">
        <span class="select-label">Select Driver</span>
        <svg class="select-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <div class="select-list" role="listbox">
        <div class="option" data-value="Kuljeet" role="option" tabindex="0">
          <div class="opt-icon">K</div><span>Kuljeet</span>
        </div>
        <div class="option" data-value="Harpreet" role="option" tabindex="0">
          <div class="opt-icon">H</div><span>Harpreet</span>
        </div>
      </div>
    </div>
  `;
            return wrap;
        }


        function getSelectedDriver(row) {
            return row.querySelector('.driver-select')?.dataset.value || '';
        }
        function setSelectedDriver(row, value) {
            const sel = row.querySelector('.driver-select');
            if (!sel) return;
            sel.dataset.value = value || '';
            sel.querySelector('.select-label').textContent = value || 'Select Driver';
        }
        function attachSelectBehavior(row) {
            const sel = row.querySelector('.driver-select');          // ðŸ‘ˆ was '.select'
            if (!sel) return;
            const trig = sel.querySelector('.select-trigger');
            const list = sel.querySelector('.select-list');

            const closeAll = () => {
                for (const open of document.querySelectorAll('.driver-select.open')) { // ðŸ‘ˆ limit to driver selects
                    open.classList.remove('open');
                    const btn = open.querySelector('.select-trigger');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
            };

            trig.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = sel.classList.contains('open');
                closeAll();
                if (!isOpen) {
                    sel.classList.add('open');
                    trig.setAttribute('aria-expanded', 'true');
                    const rect = list.getBoundingClientRect();
                    const spaceBelow = window.innerHeight - rect.top;
                    if (spaceBelow < 180) { list.style.top = 'auto'; list.style.bottom = 'calc(100% + 6px)'; }
                    else { list.style.top = 'calc(100% + 6px)'; list.style.bottom = 'auto'; }
                }
            });

            list.querySelectorAll('.option').forEach(opt => {
                opt.addEventListener('click', () => {
                    setSelectedDriver(row, opt.dataset.value);
                    closeAll();
                    const truckInput = row.querySelector('.truck');
                    truckInput.value = opt.dataset.value === 'Kuljeet' ? '702'
                        : opt.dataset.value === 'Harpreet' ? '47'
                            : '';
                });
            });

            document.addEventListener('click', closeAll);
        }


        /* ---------- Fields helpers ---------- */
        function newField({ label, placeholder, type = 'text', className = '', attrs = {} }) {
            const wrap = document.createElement('div');
            wrap.className = `field ${className}`;
            const id = 'f_' + Math.random().toString(36).slice(2);
            const isDate = type === 'date';
            wrap.innerHTML = `
        <label for="${id}">${label}</label>
        <input id="${id}" type="${type}" placeholder="${placeholder}" ${isDate ? 'inputmode=none' : ''}/>
      `;
            const input = wrap.querySelector('input');
            Object.entries(attrs).forEach(([k, v]) => input.setAttribute(k, v));
            return wrap;
        }

        function createIconButton(title, pathD, onClick) {
            const btn = document.createElement('button');
            btn.className = 'icon-btn';
            btn.type = 'button';
            btn.title = title;
            btn.setAttribute('aria-label', title);
            btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="${pathD}"/>
        </svg>`;
            btn.addEventListener('click', onClick);
            return btn;
        }

        const darkToggle = document.getElementById('darkModeToggle');

        const moonIcon = `
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
  <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/>
</svg>`;

        const sunIcon = `
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
  <circle cx="12" cy="12" r="5"></circle>
  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
</svg>`;

        // Toggle + persist
        function setDarkMode(on) {
            if (on) {
                document.body.classList.add('dark');
                localStorage.setItem('darkMode', '1');
                darkToggle.innerHTML = sunIcon;
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem('darkMode', '0');
                darkToggle.innerHTML = moonIcon;
            }
        }

        // Load preference and set icon
        setDarkMode(localStorage.getItem('darkMode') === '1');

        // Click + keyboard
        darkToggle.addEventListener('click', () => {
            setDarkMode(!document.body.classList.contains('dark'));
        });
        darkToggle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); darkToggle.click(); }
        });



        /* ---------- Broker: input-first with dropdown suggestions ---------- */
        function createBrokerChooser() {
            const wrap = document.createElement('div');
            wrap.className = 'field col-4';
            wrap.innerHTML = `
    <label>Bill To</label>
    <div class="select combo" data-value="">
      <input type="text" class="select-input broker-input" placeholder="Enter Broker Name" autocomplete="off" />
      <button type="button" class="select-caret-btn" aria-haspopup="listbox" aria-expanded="false" aria-label="Open broker list">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
      <div class="select-list" role="listbox">
        <div class="option" data-value="Roadly Logistics" role="option" tabindex="0">
          <div class="opt-icon">R</div><span>Roadly Logistics</span>
        </div>
        <div class="option" data-value="Spider Logistics" role="option" tabindex="0">
          <div class="opt-icon">S</div><span>Spider Logistics</span>
        </div>
      </div>
    </div>
  `;
            return wrap;
        }

        function getBrokerName(row) {
            return row.querySelector('.broker-input')?.value?.trim() || '';
        }

        function setBrokerName(row, value) {
            const input = row.querySelector('.broker-input');
            if (input) input.value = value || '';
        }

        function attachBrokerBehavior(row) {
            const sel = row.querySelector('.select.combo');
            if (!sel) return;

            const caretBtn = sel.querySelector('.select-caret-btn');
            const list = sel.querySelector('.select-list');
            const input = sel.querySelector('.broker-input');

            const closeAll = () => {
                document.querySelectorAll('.select.open').forEach(el => {
                    el.classList.remove('open');
                    const btn = el.querySelector('.select-caret-btn,.select-trigger');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                });
            };

            // Toggle dropdown from caret
            caretBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = sel.classList.contains('open');
                closeAll();
                if (!isOpen) {
                    sel.classList.add('open');
                    caretBtn.setAttribute('aria-expanded', 'true');
                    // drop-up if near bottom
                    const rect = list.getBoundingClientRect();
                    const spaceBelow = window.innerHeight - rect.top;
                    if (spaceBelow < 180) { list.style.top = 'auto'; list.style.bottom = 'calc(100% + 6px)'; }
                    else { list.style.top = 'calc(100% + 6px)'; list.style.bottom = 'auto'; }
                }
            });

            // Pick from list -> fill input
            list.querySelectorAll('.option').forEach(opt => {
                opt.addEventListener('click', () => {
                    input.value = opt.dataset.value || '';
                    closeAll();
                });
            });

            // Optional: close on outside click
            document.addEventListener('click', closeAll);

            // Optional: Enter selects first visible match
            input.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    sel.classList.add('open');
                    caretBtn.setAttribute('aria-expanded', 'true');
                }
            });
        }



        /* ---------- Row lifecycle ---------- */
        function addInvoiceRow(prefill = {}) {
            const row = document.createElement('div');
            row.classList.add('invoice-row');

            // Fields (precise, repeatable alignment)
            const load = newField({ label: 'Load #', placeholder: 'e.g. 12345', className: 'col-3', attrs: { class: 'load', autocomplete: 'off' } });
            const billWrap = createBrokerChooser();
            const rate = newField({ label: 'Amount ($)', placeholder: 'e.g. 650', type: 'number', className: 'col-2', attrs: { class: 'rate', step: '0.01', min: '0' } });
            const driverWrap = createDriverSelect(); // custom dropdown
            driverWrap.classList.add('col-3');
            const truck = newField({ label: 'Truck #', placeholder: 'Auto from Driver', className: 'col-2', attrs: { class: 'truck' } });
            const invoice = newField({ label: 'Invoice #', placeholder: 'Auto from Load #', className: 'col-3', attrs: { class: 'invoice' } });
            const date = newField({ label: 'Date', placeholder: '', type: 'date', className: 'col-3', attrs: { class: 'date' } });

            // Actions (Preview / Duplicate / Delete)
            const actions = document.createElement('div');
            actions.className = 'row-actions';
            const previewBtn = createIconButton('Preview PDF', 'M4 4h16v16H4z M8 8h8v8H8z', () => generateInvoicePDF(row, { download: false }));
            const duplicateBtn = createIconButton('Duplicate row', 'M16 3H6a2 2 0 0 0-2 2v10M8 7h10a2 2 0 0 1 2 2v10M8 7v10a2 2 0 0 0 2 2h10', () => duplicateRow(row));
            const removeBtn = createIconButton('Remove row', 'M3 6h18M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2', () => row.remove());
            actions.append(previewBtn, duplicateBtn, removeBtn);

            // Append
            row.append(load, billWrap, rate, driverWrap, truck, invoice, date, actions);
            if (prefill.bill) { setBrokerName(row, prefill.bill); }
            attachBrokerBehavior(row);

            invoiceContainer.appendChild(row);

            // Init values
            const dateInput = row.querySelector('.date'); dateInput.value = new Date().toISOString().split('T')[0];
            if (prefill.load) { row.querySelector('.load').value = prefill.load; }
            if (prefill.bill) { row.querySelector('.bill').value = prefill.bill; }
            if (prefill.rate) { row.querySelector('.rate').value = prefill.rate; }
            if (prefill.truck) { row.querySelector('.truck').value = prefill.truck; }
            if (prefill.invoice) { row.querySelector('.invoice').value = prefill.invoice; }
            if (prefill.date) { row.querySelector('.date').value = prefill.date; }
            if (prefill.driver) { setSelectedDriver(row, prefill.driver); }

            // Bind behaviors
            const loadInput = row.querySelector('.load');
            const invoiceInput = row.querySelector('.invoice');
            loadInput.addEventListener('input', () => { invoiceInput.value = loadInput.value || ''; });
            invoiceInput.value = loadInput.value || '';

            attachSelectBehavior(row);

            return row;
        }

        function duplicateRow(row) {
            const cloneData = {
                load: row.querySelector('.load').value,
                bill: row.querySelector('.bill').value,
                rate: row.querySelector('.rate').value,
                driver: getSelectedDriver(row),
                truck: row.querySelector('.truck').value,
                invoice: row.querySelector('.invoice').value,
                date: row.querySelector('.date').value,
            };
            const newRow = addInvoiceRow(cloneData);
            newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function clearAllRows() { invoiceContainer.innerHTML = ''; }

        /* ---------- PDF (grayscale, precise, print-first) ---------- */
        const COMPANY_NAME = 'SNA TRANSPORT INC.';
        const COMPANY_ADDRESS = '8100 Vegas Cir, West Chester, OH 45069';
        const COMPANY_CONTACT = 'snatransport12@gmail.com  â€¢  (513) 462-5849';

        function drawHeader(pdf) {
            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'bold'); pdf.setFontSize(18);
            pdf.text(COMPANY_NAME, 11.75, 14);

            pdf.setFont('helvetica', 'normal'); pdf.setFontSize(11.5);
            pdf.text(COMPANY_ADDRESS, 12, 20);
            pdf.text(COMPANY_CONTACT, 12, 25);

            // Add a logo (replace 'logo.png' with your actual logo file)
            // const img = new Image()
            // img.src = 'logo.png'
            // pdf.addImage(img, 'png', 170, 8, 30, 15)

            pdf.setDrawColor(190); pdf.setLineWidth(0.2);
            pdf.line(0, 30, pdf.internal.pageSize.width, 30);
        }

        function generateInvoicePDF(row, opts = { download: true }) {
            const pdf = new jsPDF();

            const bill = getBrokerName(row) || '';
            const load = row.querySelector('.load').value || '';
            const rate = row.querySelector('.rate').value || '';
            const invoiceNo = row.querySelector('.invoice').value || '';
            const date = row.querySelector('.date').value || '';
            const driver = getSelectedDriver(row) || '';
            const truck = row.querySelector('.truck').value || '';

            drawHeader(pdf);

            // Title + right meta block for alignment clarity
            pdf.setFont('helvetica', 'light'); pdf.setFontSize(30); pdf.setTextColor(90); pdf.text('INVOICE', 155, 20);

            pdf.setTextColor(0);
            pdf.setFont('helvetica', 'bold'); pdf.setFontSize(11.5);
            pdf.setFontSize(11.5);

            // Label
            pdf.setFont('helvetica', 'bold');
            const dateLabel = 'Date:';
            pdf.text(dateLabel, 200 - 36, 40, { align: 'right' });

            // Date value
            pdf.setFont('helvetica', 'normal');
            const dateText = date || '-';
            pdf.text(dateText, 200 - 24, 40, { align: 'right' });

            // Measure widths
            pdf.setFont('helvetica', 'bold');
            const labelWidthdate = pdf.getTextWidth(dateLabel);

            pdf.setFont('helvetica', 'normal');
            const valueWidth = pdf.getTextWidth(dateText);

            // Figure out X positions
            const padding = 2; // small gap after the date text
            const lineEndXdate = pdf.internal.pageSize.width - 12; // keep your original right edge
            const lineStartXdate = lineEndXdate - (valueWidth + labelWidthdate + padding) - 2;

            // Draw line under just the label + date text
            pdf.line(lineStartXdate, 42, lineEndXdate, 42);



            // Bill To (outlined box, no fills)
            pdf.setDrawColor(210); pdf.setLineWidth(0.2);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Invoice #', 13, 40);

            // Draw invoice number
            pdf.setFont('helvetica', 'normal');
            const invoiceText = invoiceNo || '-';
            pdf.text(invoiceText, 33, 40);

            // Measure total width of "Invoice #" label + gap + invoice number
            pdf.setFont('helvetica', 'bold');
            const labelWidth = pdf.getTextWidth('Invoice #');

            pdf.setFont('helvetica', 'normal');
            const numberWidth = pdf.getTextWidth(invoiceText);

            // Starting X for the line
            const lineStartX = 12;

            // End X based on content width + some padding
            const lineEndX = 33 + numberWidth + 2; // 2 is extra padding after the number

            // Draw the dynamic line
            pdf.line(lineStartX, 42, lineEndX, 42);


            // Keep your exact table width math for centered small table
            const wantedTableWidth = 110;
            const pageWidth = pdf.internal.pageSize.width;
            const margin = (pageWidth - wantedTableWidth) / 2;

            // Shift table right by 20pt without changing its width
            const shiftX = 17; // CHANGED: positive = move right

            // =========================
            // Helpers (no side-effects)
            // =========================
            function withPdfState(pdf, fn) {
                const hasGS = typeof pdf.saveGraphicsState === 'function' && typeof pdf.restoreGraphicsState === 'function';
                if (hasGS) pdf.saveGraphicsState();

                const prev = {
                    font: pdf.getFont ? pdf.getFont() : null,
                    size: pdf.getFontSize ? pdf.getFontSize() : null,
                    text: pdf.getTextColor ? pdf.getTextColor() : null,
                    draw: pdf.getDrawColor ? pdf.getDrawColor() : null,
                    fill: pdf.getFillColor ? pdf.getFillColor() : null,
                    line: pdf.getLineWidth ? pdf.getLineWidth() : null
                };

                try { return fn(); }
                finally {
                    if (prev.font && pdf.setFont) pdf.setFont(prev.font.fontName, prev.font.fontStyle);
                    if (prev.size != null && pdf.setFontSize) pdf.setFontSize(prev.size);
                    if (prev.text != null && pdf.setTextColor) Array.isArray(prev.text) ? pdf.setTextColor(...prev.text) : pdf.setTextColor(prev.text);
                    if (prev.draw != null && pdf.setDrawColor) Array.isArray(prev.draw) ? pdf.setDrawColor(...prev.draw) : pdf.setDrawColor(prev.draw);
                    if (prev.fill != null && pdf.setFillColor) Array.isArray(prev.fill) ? pdf.setFillColor(...prev.fill) : pdf.setFillColor(prev.fill);
                    if (prev.line != null && pdf.setLineWidth) pdf.setLineWidth(prev.line);
                    if (hasGS) pdf.restoreGraphicsState();
                }
            }

            const cardStyle = {
                pad: 6,
                radius: 2,
                stroke: [220, 220, 220],
                separator: [235, 235, 235],
                titleSize: 12,
                textSize: 11.5,
                lineHeight: 5.2,  // adjust if your doc units differ
                labelWidth: 28,
                rowGap: 2,
                titleGap: 8
            };

            // Draws a card and returns its bounds so we can place the next section precisely.
            function drawKeyValueCard(pdf, { title, x, y, w, pairs }, s = cardStyle) {
                return withPdfState(pdf, () => {
                    const innerX = x + s.pad;
                    const innerW = Math.max(0, w - s.pad * 20);
                    const valueW = Math.max(0, innerW - s.labelWidth);

                    // Use text size for measuring wraps
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(s.textSize);

                    const lineCounts = pairs.map(([_, v]) => {
                        const wrapped = pdf.splitTextToSize(String(v ?? ''), valueW);
                        return Array.isArray(wrapped) ? wrapped.length : 1;
                    });

                    const rowsH = lineCounts.reduce((a, n) => a + n * s.lineHeight, 0) + Math.max(0, pairs.length - 1) * s.rowGap;
                    const totalH = s.pad + s.titleGap + s.pad + 1;

                    // Border
                    pdf.setDrawColor(...s.stroke);
                    pdf.setLineWidth(0.4);
                    if (pdf.roundedRect) pdf.roundedRect(x, y, w, totalH, s.radius, s.radius, 'S');
                    else pdf.rect(x, y, w, totalH, 'S');

                    // Title
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(s.titleSize);
                    pdf.text(title, innerX, y + s.pad + 1);

                    // Rows
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(s.textSize);
                    let cy = y + s.pad + s.titleGap;

                    for (let i = 0; i < pairs.length; i++) {
                        const [label, value] = pairs[i];

                        // label
                        pdf.setFont('helvetica');
                        pdf.text(String(label), innerX, cy);

                        // value
                        pdf.setFont('helvetica', 'normal');
                        const wrapped = pdf.splitTextToSize(String(value ?? ''), valueW);
                        pdf.text(wrapped, innerX + s.labelWidth, cy);

                        const nLines = Array.isArray(wrapped) ? wrapped.length : 1;
                        cy += nLines * s.lineHeight;


                    }

                    return { x, y, w, h: totalH, bottom: y + totalH };
                });
            }

            // Optional: same row-rule styling you used before for AutoTable
            function rowRules(pdf, data) {
                const lastCol = data.table.columns.length - 1;
                if (data.column.index !== lastCol) return;
                const y = data.cell.y + data.cell.height;
                if (data.section === 'head') {
                    pdf.setDrawColor(210); pdf.setLineWidth(0.2);
                } else {
                    pdf.setDrawColor(235); pdf.setLineWidth(0.15);
                }
                pdf.line(data.table.startX, y, data.table.startX + data.table.width, y);
            }

            // =========================
            // Usage
            // =========================
            // Assumes: pdf (jsPDF), margin, shiftX, and your data vars exist.
            const startY = 50;
            const gapBetweenCards = 0;  // horizontal gap is baked into your Xs below
            const gapBelowCards = 6;  // vertical gap before the next table

            // LEFT card (keep your exact X/W so width math is unchanged)
            const leftCard = drawKeyValueCard(pdf, {
                title: "Bill to:",
                x: 13,   // <- your existing left X
                y: startY,
                w: 88,   // <- your existing width
                pairs: [
                    [bill || "â€”"],
                ]
            });

            // RIGHT card (keep your exact X/W so width math is unchanged)
            const rightCard = drawKeyValueCard(pdf, {
                title: "Driver / Equipment",
                x: 108,  // <- your existing right card X
                y: startY,
                w: 88,   // <- your existing width
                pairs: [
                    [`${driver || "â€”"} / ${truck || "â€”"}`]
                ]
            });


            // Compute where to start the next table (directly under the taller card)
            const nextStartY = Math.max(leftCard.bottom, rightCard.bottom) + gapBelowCards;






            // Line items (compact, Apple-ish)
            const amountText = formatCurrency(rate);

            pdf.autoTable({
                startY: nextStartY + 2,
                theme: 'plain',
                margin: { left: 12, right: 12 },
                styles: {
                    font: 'helvetica',
                    fontSize: 11.5,
                    textColor: [0, 0, 0],
                    cellPadding: { top: 3, right: 6, bottom: 3, left: 6 },
                    halign: 'left',
                    valign: 'middle',
                    lineWidth: 0 // no default borders
                },
                headStyles: {
                    fontStyle: 'bold',
                    fillColor: [248, 248, 248],
                    textColor: [0, 0, 0]
                },
                head: [['Item', 'Load #', 'Description', 'Amount']],
                body: [
                    ['Line Haul', load || 'â€”', '', amountText],
                    [
                        { content: '', colSpan: 2, styles: { halign: 'right' } }, // empty first two
                        { content: 'Total', styles: { halign: 'right', fontStyle: 'bold' } },
                        { content: amountText, styles: { halign: 'right', fontStyle: 'bold' } }
                    ]
                ],
                columnStyles: {
                    0: { cellWidth: 35, overflow: 'ellipsize' },
                    1: { cellWidth: 50, overflow: 'ellipsize' },
                    2: { cellWidth: 73, overflow: 'linebreak', halign: 'right' },
                    3: { cellWidth: 27, halign: 'right' }
                },

                // Bold total row text
                didParseCell: (data) => {
                    if (data.section === 'body' && data.row.index === 1) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                },
                // Hairline separators; stronger rule above Total
                didDrawCell: (data) => {
                    const doc = data.doc;
                    const atRowEnd = data.column.index === data.table.columns.length - 1;
                    const startX = data.table.startX;
                    const endX = startX + data.table.width;

                    // header bottom rule
                    if (data.section === 'head' && atRowEnd) {
                        const y = data.cell.y + data.cell.height;
                        doc.setDrawColor(255); doc.setLineWidth(0.2);
                        doc.line(startX, y, endX, y);
                        return;
                    }

                    if (data.section === 'body' && atRowEnd) {
                        // detect the Total row robustly
                        const isTotal =
                            data.row.index === 1 ||                       // your current layout
                            (Array.isArray(data.row.raw) && data.row.raw[1] === 'Total');

                        if (isTotal) {
                            // strong line ABOVE the total row
                            const yTop = data.cell.y;
                            doc.setDrawColor(190); doc.setLineWidth(0.3);
                            doc.line(startX, yTop, endX, yTop);
                        } else {
                            // light row divider under normal rows
                            const yBottom = data.cell.y + data.cell.height;
                            doc.setDrawColor(235); doc.setLineWidth(0.15);
                            doc.line(startX, yBottom, endX, yBottom);
                        }
                    }
                }

            });


            // Footer
            pdf.line(12, 280, pdf.internal.pageSize.width - 12, 280); // Footer line
            pdf.setFontSize(9.5); pdf.setTextColor(100);
            pdf.text('Thank you for your business! Please remit payment to SNA TRANSPORT INC. - MC 873145', 33, 285);

            if (opts.download) {
                const safeLoad = (load || 'N-A').toString().replace(/[^\w\- ]+/g, '');
                pdf.save(`Load ${safeLoad} - SNA TRANSPORT - MC 873145.pdf`);
            } else {
                const blob = pdf.output('blob'); const url = URL.createObjectURL(blob);
                window.open(url, '_blank'); setTimeout(() => URL.revokeObjectURL(url), 10000);
            }
        }

        function generateAllInvoices() {
            const rows = document.querySelectorAll('.invoice-row');
            if (!rows.length) { alert('Add at least one invoice.'); return; }
            rows.forEach(row => generateInvoicePDF(row, { download: true }));
        }

        /* ---------- Events ---------- */
        addRowButton.addEventListener('click', () => addInvoiceRow());
        clearAllButton.addEventListener('click', clearAllRows);
        generateInvoicesButton.addEventListener('click', generateAllInvoices);

        /* ---------- Start with one row ---------- */
        addInvoiceRow();
    </script>
</body>

</html>